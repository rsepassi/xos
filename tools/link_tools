#!/usr/bin/env sh
set -e

XOS_RELEASE_ZIG=
XOS_RELEASE_BUSYBOX=

tools_dir=$1

[ -e $tools_dir/.ok ] && exit 0

link_internal_tools() {
  # symlink tools
  internal_tools="
  $XOS_ROOT/cmd/build
  $XOS_ROOT/tools/fetch
  $XOS_ROOT/tools/cc
  $XOS_ROOT/tools/ar
  $XOS_ROOT/tools/fetch_urltxt
  $XOS_ROOT/tools/need
  $XOS_ROOT/tools/pkgid
  $XOS_ROOT/tools/untar
  "
  for tool in $internal_tools
  do
    ln -s $tool $tools_dir
  done
}

add_system_commands() {
  cat <<EOF > $tools_dir/system
#!/usr/bin/env sh
set -e
cmd=\$(PATH=$PATH which \$1)
shift
\$cmd \$@
EOF
  chmod +x $tools_dir/system

  cat <<EOF > $tools_dir/system_export
#!/usr/bin/env sh
set -e
export PATH=$PATH
\$@
EOF
  chmod +x $tools_dir/system_export
}

# for bootstrap0_tools, need
# if mac
# * sha256sum wrapper over shasum5.34/shasum5.30
# if alpine linux
# * apk add make
# if debian/ubuntu
# * apt-get install wget xz-utils make bzip2

bootstrap0_tools="
grep
cut
sh
sort
find
rm
mkdir
cat
chmod
env
head
tail
dirname
tar
touch
ln
wget
mv
realpath
"

bootstrap0_macos="
shasum5.34
"
bootstrap0_alpine="
ssl_client
sha256sum
"
bootstrap0_debian="
xz
sha256sum
"

bootstrap1_tools="
$bootstrap0_tools
cp
make
sed
cmp
sleep
tr
od
bzip2
awk
wc
"

link_system_tools() {
  for tool in $1
  do
    srcpath=$(which $tool || echo "")
    if [ -z "$srcpath" ]
    then
      >&2 echo "tool $tool does not exist, needed for xos bootstrap"
      exit 1
    fi
    ln -s $srcpath $tools_dir
  done
}

link_system_mktemp() {
  sysmktemp=$(which mktemp)
  cat <<EOF > $tools_dir/internal_mktemp
#!/usr/bin/env sh
set -e
$sysmktemp \$@
EOF
  chmod +x $tools_dir/internal_mktemp
}

link_bootstrap0_os() {
  case $(uname) in
    Linux)
      if grep -q Alpine /etc/os-release
      then
        link_system_tools "$bootstrap0_alpine"
      else
        link_system_tools "$bootstrap0_debian"
      fi
      ;;
    Darwin)
      link_system_tools "$bootstrap0_macos"
      cat <<EOF > $tools_dir/sha256sum
#!/usr/bin/env sh
set -e
shasum5.34 -a 256 \$@
EOF
      chmod +x $tools_dir/sha256sum
      ;;
    *)
      >&2 echo "unrecognized os $(uname), bootstrap may fail"
      ;;
  esac
}

if [ -e $tools_dir/.bootstrap0 ]
then
  # build zig
  rm -rf $tools_dir
  mkdir -p $tools_dir
  link_system_tools "$bootstrap0_tools"
  link_bootstrap0_os
  link_system_mktemp
  link_internal_tools
  echo "bootstrap0" > $tools_dir/.xos
elif [ -e $tools_dir/.bootstrap1 ]
then
  # build busybox
  zigpath=$(realpath $tools_dir/zig)
  rm -rf $tools_dir
  mkdir -p $tools_dir
  link_system_tools "$bootstrap1_tools"
  link_bootstrap0_os
  link_system_mktemp
  ln -s $zigpath $tools_dir
  link_internal_tools
  echo "bootstrap1" > $tools_dir/.xos
else
  # bootstrap: builds zig, busybox, and links all tools
  mkdir -p $tools_dir

  if [ -z "$ARCH_HOST" ]
  then
    case $(uname -m) in
      arm64)
        isa=aarch64
        ;;
      x86_64)
        isa=x86_64
        ;;
      *)
        >&2 echo "unrecognized arch $(uname -m). set ARCH_HOST="
        exit 1
        ;;
    esac

    case $(uname) in
      Linux)
        os=linux
        ;;
      Darwin)
        os=macos
        ;;
      *)
        >&2 echo "unrecognized os $(uname). set ARCH_HOST="
        exit 1
        ;;
    esac

    ARCH_HOST="$isa-$os"
  fi

  if [ -z "$XOS_RELEASE_ZIG" ]
  then
    touch $tools_dir/.bootstrap0
    zigid=$(ARCH_HOST=$ARCH_HOST ARCH= OPT=s $XOS_ROOT/cmd/build zig)
  else
    zigid=$XOS_RELEASE_ZIG
  fi

  if [ -z "$XOS_RELEASE_BUSYBOX" ]
  then
    ln -s $BUILD_CACHE/$zigid/out/zig $tools_dir
    touch $tools_dir/.bootstrap1
    bbid=$(ARCH= OPT=s $XOS_ROOT/cmd/build busybox)
  else
    bbid=$XOS_RELEASE_BUSYBOX
  fi

  bbtools="
    mkdir
    ls
    rm
    mv
    cp
    ln
    basename
    dirname
    realpath
    tar
    gzip
    unzip
    wget
    sha256sum
    cat
    cut
    grep
    head
    tail
    which
    env
    touch
    find
    sed
    sleep
    bzip2
    awk
    wc
    xargs
    sort
    uniq
    diff
    chmod
    sh
  "

  rm -rf $tools_dir
  mkdir -p $tools_dir
  for tool in $bbtools
  do
    ln -s $BUILD_CACHE/$bbid/out/bin/busybox $tools_dir/$tool
  done
  ln -s $BUILD_CACHE/$zigid/out/zig $tools_dir

  cat <<EOF > $tools_dir/internal_mktemp
#!/usr/bin/env sh
set -e
$BUILD_CACHE/$bbid/out/bin/busybox mktemp \$@
EOF
  chmod +x $tools_dir/internal_mktemp

  add_system_commands
  link_internal_tools

  # xos id
  buildfiles="
    cmd/build
    tools/cc
    tools/ar
    tools/fetch
    tools/fetch_urltxt
    tools/link_tools
    tools/need
    tools/pkgid
    tools/untar
  "
  xosid() {
    echo "$zigid  zig"
    echo "$bbid  busybox"
    sha256sum $(echo $buildfiles | sort)
  }
  xosid > $tools_dir/.xos
  touch $tools_dir/.ok
fi
